apiVersion: rule.policycow.live/v1alpha1
kind: rule
meta:
  name: GCPCloudStorageEncryptionEnabled
  purpose: Ensures Cloud Storage buckets use encryption, requiring CMEK for compliance
    to enhance security, data protection, and access control.
  description: Ensures Cloud Storage buckets use encryption, requiring CMEK for compliance
    to enhance security, data protection, and access control.
  labels:
    appType:
      - httprequest
    environment:
      - logical
    execlevel:
      - app
  app: HttpRequest
  annotations: {}
spec:
  inputs:
    BucketsRequestConfigFile: <<MINIO_FILE_PATH>>                           # Request config file to get the buckets list from GCP Cloud Storage
    CheckIfEncryptionExistsConditionConfig: <<MINIO_FILE_PATH>>             # Condition config file to check if Encryption exists or not 
    OutputFileFormat: JSON
    TransformEncryptionConfigFile: <<MINIO_FILE_PATH>>                      # Transform config file to standardize the report
    ExtractBucketsJQExpression: .[].items[]
  inputsMeta__:
    - name: BucketsRequestConfigFile
      dataType: HTTP_CONFIG
      defaultValue: <<MINIO_FILE_PATH>>
      format: toml
      showField: true
      required: true
      allowedValues: []
      repeated: false
      explanation: ''
    - name: CheckIfEncryptionExistsConditionConfig
      dataType: FILE
      defaultValue: <<MINIO_FILE_PATH>>
      format: toml
      showField: true
      required: true
      allowedValues: []
      repeated: false
      explanation: ''
    - name: OutputFileFormat
      dataType: STRING
      defaultValue: JSON
      showField: true
      required: true
      allowedValues:
        - JSON
        - CSV
        - PARQUET
      repeated: false
      explanation: ''
    - name: TransformEncryptionConfigFile
      dataType: FILE
      defaultValue: <<MINIO_FILE_PATH>>
      format: toml
      showField: true
      required: true
      allowedValues: []
      repeated: false
      explanation: ''
    - name: ExtractBucketsJQExpression
      dataType: JQ_EXPRESSION
      defaultValue: .[].items[]
      showField: true
      required: true
      allowedValues: []
      repeated: false
  tasks:
    - name: ExecuteHttpRequestV2
      alias: GetBucketsList
      type: task
      purpose: ExecuteHttpRequestV2
      description: Executes HTTP API requests with configurable authentication, data
        handling, and response processing. Supports batch requests, flexible
        response transformation, and error management for reliable API
        integration and data collection.
      appTags:
        appType:
          - httprequest
        environment:
          - logical
        execlevel:
          - app
    - name: ExtractDataUsingJQV2
      alias: ExtractBuckets
      type: task
      purpose: ExtractDataUsingJQV2
      description: Extract and transform JSON data using JQ expressions. Supports batch
        processing with configurable chunk sizes and error handling for reliable
        processing.
      appTags:
        appType:
          - nocredapp
        environment:
          - logical
        execlevel:
          - app
    - name: CheckConditionV2
      alias: CheckIfEncryptionExists
      type: task
      purpose: CheckConditionV2
      description: Validates data records against configurable conditions. Splits input
        data into matched and unmatched files using criteria such as text
        patterns, number ranges, dates, or CEL expressions. Also supports field
        updates and conditional transformations to ensure compliance and data
        quality.
      appTags:
        appType:
          - nocredapp
        environment:
          - logical
        execlevel:
          - app
    - name: MergeDataV2
      alias: MergeEncryptionFiles
      type: task
      purpose: MergeDataV2
      description: Combine data from two input files using flexible merge strategies.
        Supports APPEND (stack rows vertically) and CONCATENATE (join columns
        horizontally by position). Handles multiple file formats with error
        handling for reliable integration.
      appTags:
        appType:
          - nocredapp
        environment:
          - logical
        execlevel:
          - app
    - name: TransformDataV2
      alias: TransformEncryptionFile
      type: task
      purpose: TransformDataV2
      description: Transform and manipulate data columns by adding, updating, deleting,
        reordering, or deduplicating fields. Supports conditional logic,
        cross-file data mapping, function-based calculations, and complex
        restructuring for compliance and reporting.
      appTags:
        appType:
          - nocredapp
        environment:
          - logical
        execlevel:
          - app
  ioMap:
    - GetBucketsList.Input.RequestConfigFile:=*.Input.BucketsRequestConfigFile
    - ExtractBuckets.Input.InputFile:=GetBucketsList.Output.OutputFile
    - ExtractBuckets.Input.JQExpression:=*.Input.ExtractBucketsJQExpression
    - CheckIfEncryptionExists.Input.InputFile:=ExtractBuckets.Output.OutputFile
    - CheckIfEncryptionExists.Input.ConditionConfig:=*.Input.CheckIfEncryptionExistsConditionConfig
    - CheckIfEncryptionExists.Input.OutputFileFormat:=*.Input.OutputFileFormat
    - MergeEncryptionFiles.Input.InputFile1:=CheckIfEncryptionExists.Output.UnmatchedConditionFile
    - MergeEncryptionFiles.Input.InputFile2:=CheckIfEncryptionExists.Output.MatchedConditionFile
    - TransformEncryptionFile.Input.InputFile1:=MergeEncryptionFiles.Output.MergedData
    - TransformEncryptionFile.Input.TransformConfigFile:=*.Input.TransformEncryptionConfigFile
    - TransformEncryptionFile.Input.OutputFileFormat:=*.Input.OutputFileFormat
    - '*.Output.CompliancePCT_:=TransformEncryptionFile.Output.CompliancePCT_'
    - '*.Output.ComplianceStatus_:=TransformEncryptionFile.Output.ComplianceStatus_'
    - '*.Output.LogFile:=TransformEncryptionFile.Output.LogFile'
    - '*.Output.GCPCloudStorageEncryptionStatusReport:=TransformEncryptionFile.Output.OutputFile'
